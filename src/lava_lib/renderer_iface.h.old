#ifndef SRC_LAVA_LIB_RENDERER_IFACE_H_
#define SRC_LAVA_LIB_RENDERER_IFACE_H_

#include <memory>
#include <map>

#include "glm/glm/mat4x4.hpp"

#include "display.h"
#include "renderer.h"
#include "Falcor/Scene/MaterialX/MaterialX.h"


namespace lava {


class SceneBuilder;

class RendererIface {
 public:
    struct DisplayData {
        Display::DisplayType                                            displayType;    // __HYDRA__ is a special virtual type
        Display::TypeFormat                                             typeFormat;
        std::vector<std::pair<std::string, std::vector<std::string>>>   displayStringParameters;
        std::vector<std::pair<std::string, std::vector<int>>>           displayIntParameters;
        std::vector<std::pair<std::string, std::vector<float>>>         displayFloatParameters;

        uint8_t*                                                        pDstData = nullptr; // __HYDRA__ virtual display destination data pointer
    };

    /* FrameData frame specific data
     */
    struct _FrameData {
        double time = 0.0;

        // image section
        uint imageWidth = 0;
        uint imageHeight = 0;
        uint imageSamples = 16;
        std::string imageFileName = "";

        // camera section
        std::string cameraProjectionName = "perspective";
        double      cameraNearPlane = 0.01;
        double      cameraFarPlane  = 1000.0;
        glm::mat4   cameraTransform;
        double      cameraFocalLength = 1.0;
        double      cameraFrameHeight = 1.0;
    };

    struct EnvLightData {
        bool        phantom = false;
        glm::mat4   transform;
        glm::vec3   intensity = {1, 1, 1};
        std::string imageFileName = "";
    };

 public:
    using UniquePtr = std::unique_ptr<RendererIface>;
    using UniqueConstPtr = std::unique_ptr<const RendererIface>;

    RendererIface(std::shared_ptr<Renderer> pRenderer);
    ~RendererIface();

    void setEnvVariable(const std::string& key, const std::string& value);

    /** get string expanded with local env variables
     */
    std::string getExpandedString(const std::string& s);

    /**
    */
    //bool openDisplay(const std::string& image_name, uint width, uint height);

    /**
    */
    bool setDisplay(const DisplayData& display_data);  

    /**
    */
    bool addPlane(const PlaneData& plane_data);

    /**
    */
    void renderFrame(const Renderer::FrameInfo& frame_info, const std::string& file_name);

    /**
    */
    bool addMaterialX(Falcor::MaterialX::UniquePtr pMaterialX);

    /** load and execute python script file
     */
    bool loadScriptFile(const std::string& file_name);

    /** load and deffered execute (before frame being rendered) python script file.
     */
    void loadDeferredScriptFile(const std::string& file_name);

    /**
    */
    std::shared_ptr<SceneBuilder> getSceneBuilder();

    bool initRenderer();
    //void initRendererGlobalData(const GlobalData& global_data);
    bool isRendererInitialized() const;

 public:
    // __HYDRA__ public section ( to be removed soon )

    /** Get renderer direct access
     */
    std::shared_ptr<Renderer>           renderer() const { return mpRenderer; }

 private:
    Display::SharedPtr display() { return mpDisplay; };

 private:
    std::map<std::string, std::string>  mEnvmap;
    std::shared_ptr<Renderer>           mpRenderer;

    Display::SharedPtr                  mpDisplay;

    //GlobalData                          mGlobalData;

    std::vector<std::string>            mDeferredScriptFileNames;

    friend class Renderer;
};

}  // namespace lava

#endif  // SRC_LAVA_LIB_RENDERER_IFACE_H_